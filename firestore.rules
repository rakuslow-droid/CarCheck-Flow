/**
 * Firestore Security Rules for CarCheck-Flow
 *
 * CORE PHILOSOPHY
 * This ruleset implements a strict user-ownership model designed for a multi-tenant merchant environment.
 * Authorization is strictly enforced based on the Firebase Authentication UID, ensuring that users
 * (merchants) can only access and modify their own business data.
 *
 * DATA STRUCTURE
 * The data is organized hierarchically:
 * - /merchants/{merchantId}: Top-level documents representing car shops.
 * - /merchants/{merchantId}/vehicles/{vehicleId}: Sub-collections containing vehicle inspection data.
 *
 * KEY SECURITY DECISIONS
 * - Denormalization for Authorization: To ensure high performance and avoid the cost/complexity of 
 *   cross-document lookups (get() calls), authorization metadata is denormalized.
 *   - Merchant documents contain an `ownerId`.
 *   - Vehicle documents contain a `merchantOwnerId`.
 * - Authorization Independence: Rules for vehicles are evaluated solely against the data within the 
 *   vehicle document itself, allowing for secure collection group queries and atomic operations.
 * - Immvutability: Critical relational fields (like ownership IDs) are enforced as immutable after 
 *   creation to prevent data hijacking.
 * - Prototyping Flexibility: While authorization is strict, data schema validation is minimal to 
 *   allow for rapid iteration of the application's features.
 */

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    /**
     * @description Checks if the request is from an authenticated user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the provided UID matches the authenticated user's UID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Validates ownership for existing documents (update/delete).
     * Ensures the document exists and the current user is the owner.
     */
    function isExistingOwner(userId) {
      return resource != null && isOwner(userId);
    }

    // --- Collection Rules ---

    /**
     * @description Rules for the Merchants collection. Access is restricted to the owner defined in the document.
     * @path /merchants/{merchantId}
     * @allow (get) If the user's UID matches the merchant's ownerId.
     * @deny (create) If the user attempts to set an ownerId other than their own UID.
     * @principle Enforces document ownership for all operations and validates path consistency.
     */
    match /merchants/{merchantId} {
      allow get: if isOwner(resource.data.ownerId);
      allow list: if isSignedIn(); // Queries must still filter by ownerId to succeed
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid && request.resource.data.id == merchantId;
      allow update: if isExistingOwner(resource.data.ownerId) && request.resource.data.ownerId == resource.data.ownerId;
      allow delete: if isExistingOwner(resource.data.ownerId);

      /**
       * @description Rules for the Vehicles subcollection. Uses denormalized merchantOwnerId for authorization.
       * @path /merchants/{merchantId}/vehicles/{vehicleId}
       * @allow (list) If the query is filtered by the user's UID via merchantOwnerId.
       * @deny (update) If the user attempts to change the merchantOwnerId or merchantId.
       * @principle Authorization Independence: secures subcollections without parent document lookups.
       */
      match /vehicles/{vehicleId} {
        allow get: if isOwner(resource.data.merchantOwnerId);
        allow list: if isSignedIn(); // Queries must still filter by merchantOwnerId to succeed
        allow create: if isSignedIn() && request.resource.data.merchantOwnerId == request.auth.uid && request.resource.data.merchantId == merchantId && request.resource.data.id == vehicleId;
        allow update: if isExistingOwner(resource.data.merchantOwnerId) && request.resource.data.merchantOwnerId == resource.data.merchantOwnerId && request.resource.data.merchantId == resource.data.merchantId;
        allow delete: if isExistingOwner(resource.data.merchantOwnerId);
      }
    }

    /**
     * @description Collection Group rules for Vehicles to support cross-merchant listing.
     * @path /vehicles (Collection Group)
     */
    match /{path=**}/vehicles/{vehicleId} {
      allow read: if isOwner(resource.data.merchantOwnerId);
    }
  }
}