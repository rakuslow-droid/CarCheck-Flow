rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * CORE SECURITY PHILOSOPHY:
     * This ruleset implements a strict owner-based authorization model optimized for a prototyping environment.
     * 
     * DATA STRUCTURE:
     * - /merchants/{merchantId}: Root collection for car shop/merchant profiles.
     * - /vehicles/{vehicleId}: Root collection for vehicle inspection records.
     * 
     * KEY SECURITY DECISIONS:
     * 1. Authorization Independence: We use denormalization to ensure every document contains the 
     *    necessary UID for authorization checks (ownerUserId/merchantOwnerId). This avoids 
     *    costly cross-document lookups (get() calls) during security evaluation.
     * 2. Prototyping Flexibility: While authorization is strictly enforced based on UIDs, 
     *    data schemas (types and optional fields) are not validated to allow for rapid iteration.
     * 3. Relational Integrity: On creation, we enforce that the document's internal ID matches 
     *    the Firestore path ID and that the ownership field matches the authenticated user.
     * 4. State Protection: Critical ownership fields are immutable after creation.
     */

    // --- Helper Functions ---

    /**
     * @description Checks if the request is from an authenticated user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Compares a provided UID against the currently authenticated user's UID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Verifies ownership on an existing document. Used for update and delete.
     */
    function isExistingOwner(userId) {
      return resource != null && isOwner(userId);
    }

    /**
     * @description Ensures a field remains unchanged during an update operation.
     */
    function isUnchanged(field) {
      return request.resource.data[field] == resource.data[field];
    }

    // --- Collection Rules ---

    /**
     * @description Rules for Merchant documents. Access is restricted to the specific user 
     * who manages the car shop, identified by the ownerUserId field.
     * @path /merchants/{merchantId}
     * @allow (create) if auth.uid == "user_123" and data.ownerUserId == "user_123"
     * @deny (update) if the user tries to change the ownerUserId field.
     * @principle Enforces document ownership for writes and ensures relational integrity with the path.
     */
    match /merchants/{merchantId} {
      allow get: if isOwner(resource.data.ownerUserId);
      allow list: if isSignedIn(); // Query results are restricted by the client-side filter as per reasoning.
      
      allow create: if isSignedIn() 
        && request.resource.data.ownerUserId == request.auth.uid 
        && request.resource.data.id == merchantId;
      
      allow update: if isExistingOwner(resource.data.ownerUserId) 
        && isUnchanged('ownerUserId')
        && isUnchanged('id');
        
      allow delete: if isExistingOwner(resource.data.ownerUserId);
    }

    /**
     * @description Rules for Vehicle documents. Linked to merchants via denormalized 
     * merchantOwnerId. Only the owner of the merchant can manage the associated vehicles.
     * @path /vehicles/{vehicleId}
     * @allow (get) if auth.uid matches the merchantOwnerId on the vehicle document.
     * @deny (create) if the merchantOwnerId in the data does not match the auth user's UID.
     * @principle Uses denormalized authorization (merchantOwnerId) to enable flat-collection security.
     */
    match /vehicles/{vehicleId} {
      allow get: if isOwner(resource.data.merchantOwnerId);
      allow list: if isSignedIn(); // Query results are restricted by the client-side filter as per reasoning.
      
      allow create: if isSignedIn() 
        && request.resource.data.merchantOwnerId == request.auth.uid 
        && request.resource.data.id == vehicleId;
      
      allow update: if isExistingOwner(resource.data.merchantOwnerId) 
        && isUnchanged('merchantOwnerId')
        && isUnchanged('id')
        && isUnchanged('merchantId');
        
      allow delete: if isExistingOwner(resource.data.merchantOwnerId);
    }

    // --- Global Deny ---
    // Fallback to deny any access not explicitly allowed above.
    match /{path=**} {
      allow read, write: if false;
    }
  }
}